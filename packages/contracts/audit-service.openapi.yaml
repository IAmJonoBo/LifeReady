openapi: 3.1.0
info:
  title: LifeReady Audit Service
  version: 0.1.0
jsonSchemaDialect: https://json-schema.org/draft/2020-12/schema
servers:
  - url: https://api.lifeready.local/audit
tags:
  - name: audit
paths:
  /v1/audit/events:
    post:
      tags: [audit]
      security: [{ bearerAuth: [] }]
      summary: Append audit event (internal services)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AuditAppend" }
      responses:
        "201":
          description: Appended
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuditEvent" }
        default:
          $ref: "./common.openapi.yaml#/components/responses/ProblemDetails"

  /v1/audit/export:
    get:
      tags: [audit]
      security: [{ bearerAuth: [] }]
      summary: Export audit proof bundle (hash head + verification inputs)
      parameters:
        - in: query
          name: case_id
          schema: { $ref: "#/components/schemas/Uuid" }
      responses:
        "200":
          description: Export ready
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuditExport" }
        default:
          $ref: "./common.openapi.yaml#/components/responses/ProblemDetails"

components:
  securitySchemes:
    bearerAuth: { type: http, scheme: bearer, bearerFormat: JWT }
  schemas:
    Uuid: { $ref: "./common.openapi.yaml#/components/schemas/Uuid" }
    IsoDateTime:
      { $ref: "./common.openapi.yaml#/components/schemas/IsoDateTime" }
    SensitivityTier:
      { $ref: "./common.openapi.yaml#/components/schemas/SensitivityTier" }
    AuditAppend:
      type: object
      required: [actor_principal_id, action, tier, payload]
      properties:
        actor_principal_id: { $ref: "#/components/schemas/Uuid" }
        action: { type: string, maxLength: 120 }
        tier: { $ref: "#/components/schemas/SensitivityTier" }
        case_id: { $ref: "#/components/schemas/Uuid" }
        payload:
          type: object
          additionalProperties: true
    AuditEvent:
      type: object
      required: [event_id, created_at, prev_hash, event_hash]
      properties:
        event_id: { $ref: "#/components/schemas/Uuid" }
        created_at: { $ref: "#/components/schemas/IsoDateTime" }
        prev_hash: { type: string, pattern: "^[a-f0-9]{64}$" }
        event_hash: { type: string, pattern: "^[a-f0-9]{64}$" }
    AuditExport:
      type: object
      required: [download_url, expires_at, head_hash]
      properties:
        download_url: { type: string, format: uri }
        expires_at: { $ref: "#/components/schemas/IsoDateTime" }
        head_hash: { type: string, pattern: "^[a-f0-9]{64}$" }
